var t,n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])},n(t,e)};function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function r(t,n,e,r){return new(e||(e=Promise))((function(o,u){function i(t){try{c(r.next(t))}catch(t){u(t)}}function a(t){try{c(r.throw(t))}catch(t){u(t)}}function c(t){var n;t.done?o(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(i,a)}c((r=r.apply(t,n||[])).next())}))}function o(t,n){var e,r,o,u,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function a(u){return function(a){return function(u){if(e)throw new TypeError("Generator is already executing.");for(;i;)try{if(e=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,r=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){i.label=u[1];break}if(6===u[0]&&i.label<o[1]){i.label=o[1],o=u;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(u);break}o[2]&&i.ops.pop(),i.trys.pop();continue}u=n.call(t,i)}catch(t){u=[6,t],r=0}finally{e=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,a])}}}function u(t){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u(t)}function i(t){return new Promise((function(n,e){t.oncomplete=t.onsuccess=function(){return n(t.result)},t.onabort=t.onerror=function(){return e(t.error)}}))}function a(t,n){var e,r=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(t){var n=function(){return indexedDB.databases().finally(t)};e=setInterval(n,100),n()})).finally((function(){return clearInterval(e)})):Promise.resolve()).then((function(){var e=indexedDB.open(t);return e.onupgradeneeded=function(){return e.result.createObjectStore(n)},i(e)}));return function(t,e){return r.then((function(r){return e(r.transaction(n,t).objectStore(n))}))}}function c(){return t||(t=a("keyval-store","keyval")),t}function s(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c();return n("readonly",(function(n){return i(n.get(t))}))}function f(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c();return n("readwrite",(function(n){return t.forEach((function(t){return n.put(t[1],t[0])})),i(n.transaction)}))}function l(t,n){return t("readonly",(function(t){return t.openCursor().onsuccess=function(){this.result&&(n(this.result),this.result.continue())},i(t.transaction)}))}function h(t,n,e){var r,o,u,i,a;function c(){var s=Date.now()-i;s<n&&s>=0?r=setTimeout(c,n-s):(r=null,e||(a=t.apply(u,o),u=o=null))}null==n&&(n=100);var s=function(){u=this,o=arguments,i=Date.now();var s=e&&!r;return r||(r=setTimeout(c,n)),s&&(a=t.apply(u,o),u=o=null),a};return s.clear=function(){r&&(clearTimeout(r),r=null)},s.flush=function(){r&&(a=t.apply(u,o),u=o=null,clearTimeout(r),r=null)},s}h.debounce=h;var d=h,p=function(){function t(n,e,r){var o=this;this.delWhenOutTime=d((function(){(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c(),n=[];return l(t,(function(t){return n.push(t.key)})).then((function(){return n}))})(o.customStore).then((function(t){t.map((function(t){"string"==typeof t&&t.endsWith("outTime")&&s(t,o.customStore).then((function(n){var e;e=n,Date.now()>o.OUT_TIME+e&&function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:c())("readwrite",(function(n){return t.forEach((function(t){return n.delete(t)})),i(n.transaction)}))}([t,t.replace("_outTime","")],o.customStore).catch((function(){}))}))}))})).catch((function(t){console.error("[idb]keys",t)}))}),t.DEBOUNCE_TIME),this.preAppKey=n+"_",this.OUT_TIME=e||6048e5,t.IS_SUP_IDB||console.error("[idb]不支持"),this.customStore=a(r||"keyval-store","keyval")}return t.prototype.setIDB=function(n,e){return r(this,void 0,void 0,(function(){return o(this,(function(r){return t.IS_SUP_IDB?(this.delWhenOutTime(),[2,f([["".concat(this.preAppKey).concat(n,"_outTime"),Date.now()+this.OUT_TIME],["".concat(this.preAppKey).concat(n),e]],this.customStore)]):[2,Promise.reject(t.ERROR_TXT)]}))}))},t.prototype.getIDB=function(n){return r(this,void 0,void 0,(function(){return o(this,(function(e){return t.IS_SUP_IDB?[2,s("".concat(this.preAppKey).concat(n),this.customStore)]:[2,Promise.reject(t.ERROR_TXT)]}))}))},t.IS_SUP_IDB="object"===u(window.indexedDB),t.ERROR_TXT="【idb】not support idb",t.DEBOUNCE_TIME=3e3,t}(),m=function(t){function n(n,e,r){return t.call(this,n,e,r)||this}return e(n,t),n.prototype.getFetchMd5DB=function(t){var n=t.reqMd5,e=t.funName;return r(this,void 0,void 0,(function(){return o(this,(function(t){return[2,this.getIDB("".concat(e,"_").concat(n)).then((function(t){return t})).catch((function(t){return console.error("[idb]getFetchMd5DB",t),!1}))]}))}))},n.prototype.setFetchMd5DB=function(t){var n=t.reqMd5,e=t.funName,u=t.resultData;return r(this,void 0,void 0,(function(){return o(this,(function(t){return[2,this.setIDB("".concat(e,"_").concat(n),u).then((function(t){return t})).catch((function(t){return console.error("[idb]setFetchMd5DB",t),!1}))]}))}))},n}(p),v=function(t){return t.params},y=function(t){var n=t.data;return n.data?{data:n.data}:n},b=function(t){return!!t.data},D=function(t){function n(n){var e=n.appKey,r=n.outTime,o=n.formatParams,u=n.isRealData,i=n.formatResultData,a=n.storeName,c=n.md5,s=t.call(this,e,r,a)||this;return s.formatParams=o||v,s.formatResultData=i||y,s.isRealData=u||b,s.md5=c||null,s}return e(n,t),n.prototype.httpWithIDB=function(t){var n=t.axiosRequestConfig,e=t.funName,u=t.DbHttp,i=t.fetchKey,a=t.newDataCb,c=t.fetchDataCb,s=t.formatParams,f=t.isRealData,l=t.formatResultData,h=t.fetchPromise;return r(this,void 0,void 0,(function(){var t,d,p,m,v,y,b=this;return o(this,(function(D){switch(D.label){case 0:return t=null==n?void 0:n.url,s=s||this.formatParams,f=f||this.isRealData,l=l||this.formatResultData,d=i||this.md5(JSON.stringify(s({url:t,axiosRequestConfig:n,funName:e,DbHttp:u,params:(null==n?void 0:n.params)||(null==n?void 0:n.data)||{}}))),p="0",m=this.getFetchMd5DB({reqMd5:d,funName:e}).then((function(r){var o=r&&JSON.parse(r);return f({url:t,axiosRequestConfig:n,funName:e,DbHttp:u,data:o})?(p=r,Promise.resolve(o)):(p="-1",new Promise((function(){})))})).catch((function(t){return console.warn("[idb]getFetchMd5DB不支持",t),new Promise((function(){}))})),y=function(i){return r(b,void 0,void 0,(function(){var r,s;return o(this,(function(o){switch(o.label){case 0:return i=l({url:t,axiosRequestConfig:n,funName:e,DbHttp:u,data:i}),r=JSON.stringify(i),[4,this.setFetchMd5DB({reqMd5:d,funName:e,resultData:r})];case 1:return o.sent(),s="0"!==p&&"-1"!==p&&r!==p,c&&c({data:i,isNewData:s}),s&&a&&a(i),[2,Promise.resolve(i)]}}))}))},v=h?h.then((function(t){return r(b,void 0,void 0,(function(){return o(this,(function(n){return[2,y(t)]}))}))})).catch((function(t){return r(b,void 0,void 0,(function(){return o(this,(function(n){return console.error("[idb]fnHttp",t),[2,Promise.reject(t)]}))}))})):u(n).then((function(t){return r(b,void 0,void 0,(function(){return o(this,(function(n){return[2,y(t)]}))}))})).catch((function(t){return r(b,void 0,void 0,(function(){return o(this,(function(n){return console.error("[idb]fnHttp",t),[2,Promise.reject(t)]}))}))})),[4,Promise.race([v,m]).then((function(t){return t})).catch((function(t){return console.error("[idb]Promise.race",t),t}))];case 1:return[2,D.sent()]}}))}))},n}(m);export{D as default};
//# sourceMappingURL=bundle.js.map
